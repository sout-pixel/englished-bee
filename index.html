<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Englishes Bee - Mode Selection</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --text: #333;
            --bg: #fcfcfc;
            --accent: #555; /* è½ã¡ç€ã„ãŸã‚°ãƒ¬ãƒ¼ */
            --border: #ddd;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box;
        }
        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å»ƒæ­¢ã—ã€ãƒŸãƒ‹ãƒãƒ«ãªã‚³ãƒ³ãƒ†ãƒŠã«å¤‰æ›´ */
        .container {
            max-width: 600px; width: 100%; text-align: center;
        }
        h1 { margin: 0 0 30px 0; font-size: 1.5rem; letter-spacing: 1px; font-weight: normal; }
        
        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚’ã‚·ãƒ³ãƒ—ãƒ«ã« */
        .mode-selector { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
        .mode-btn {
            background: none; border: none; padding: 8px 0;
            font-size: 0.9rem; cursor: pointer; color: #999;
            border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .mode-btn.active { color: var(--text); border-bottom-color: var(--accent); }

        /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè¡¨ç¤º */
        .accent-display { font-size: 0.9rem; color: #777; margin-bottom: 20px; }

        /* å†ç”Ÿãƒœã‚¿ãƒ³ */
        button#play-btn {
            background: none; border: 2px solid var(--border); width: 70px; height: 70px; border-radius: 50%;
            font-size: 1.8rem; cursor: pointer; margin: 0 auto 30px auto; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; color: var(--accent);
        }
        button#play-btn:hover { border-color: var(--accent); }
        button#play-btn:active { transform: scale(0.95); }

        /* å…¥åŠ›æ¬„ */
        input[type="text"] {
            width: 100%; max-width: 300px; padding: 10px; font-size: 1.2rem;
            border: none; border-bottom: 2px solid var(--border);
            text-align: center; outline: none; text-transform: lowercase; margin-bottom: 20px;
            background: transparent; transition: border-color 0.2s;
        }
        input[type="text"]:focus { border-bottom-color: var(--accent); }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆæ­£èª¤è¡¨ç¤ºï¼‰ */
        .feedback { min-height: 24px; margin-bottom: 30px; font-size: 1rem; }
        .correct-answer { color: #d32f2f; font-weight: bold; } /* é–“é•ãˆãŸæ™‚ã®ç­”ãˆè¡¨ç¤º */

        /* å±¥æ­´ã‚¨ãƒªã‚¢ï¼ˆæœ€åˆã¯éš ã™ï¼‰ */
        #history-section {
            display: none; /* ã‚²ãƒ¼ãƒ ä¸­ã¯éè¡¨ç¤º */
            margin-top: 50px; width: 100%; text-align: left; border-top: 1px solid var(--border); padding-top: 30px;
        }
        .history-title { font-size: 1.1rem; margin-bottom: 20px; text-align: center; }
        .history-list { list-style: none; padding: 0; }
        .history-item {
            padding: 15px; border-bottom: 1px solid var(--border);
            cursor: pointer; transition: background 0.2s;
        }
        .history-item:hover { background: #f9f9f9; }
        .history-word { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        .history-status { font-size: 0.8rem; }
        .status-correct { color: #2e7d32; } .status-wrong { color: #d32f2f; }
        
        /* è©³ç´°æƒ…å ±ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãéƒ¨åˆ†ï¼‰ */
        .word-details { display: none; margin-top: 10px; font-size: 0.9rem; color: #555; padding-left: 10px; border-left: 3px solid var(--border); }
        .detail-row { margin-bottom: 5px; }
        .detail-label { font-weight: bold; margin-right: 5px; }
    </style>
</head>
<body></body>
    <div class="container" id="game-container">
        <h1>Englishes Bee</h1>
        
        <div class="mode-selector" id="mode-container">
            Loading levels...
        </div>

        <div id="accent-display" class="accent-display">Loading...</div>
        
        <button id="play-btn" onclick="speakWord()">ğŸ”Š</button>
        <input type="text" id="user-input" placeholder="type here" onkeydown="if(event.key === 'Enter') checkAnswer()" autocomplete="off">
        <div id="feedback" class="feedback"></div>
        
        </div>

    <div class="container" id="history-section">
        <h2 class="history-title">Today's Session History</h2>
        <ul class="history-list" id="history-list">
            </ul>
        <button onclick="location.reload()" style="margin-top:30px; background:none; border:1px solid #ddd; padding:10px 20px; cursor:pointer;">Restart Session</button>
    </div>
    <script>
        let database = {};
        let currentMode = "world";
        let currentList = [];
        let currentProblem = null;
        let sessionHistory = [];
        const PROBLEMS_PER_SESSION = 5;
    
        // å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆè¡¨ç¤ºåã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ¼ãƒ‰ï¼‰
        const ACCENTS = [
            { code: "us", name: "American Accent ğŸ‡ºğŸ‡¸" },
            { code: "uk", name: "British Accent ğŸ‡¬ğŸ‡§" },
            { code: "au", name: "Australian Accent ğŸ‡¦ğŸ‡º" },
            { code: "in", name: "Indian Accent ğŸ‡®ğŸ‡³" }
        ];
    
        async function loadDatabase() {
        try {
            const response = await fetch('words.json');
            database = await response.json();
            
            // â˜…ã“ã“ãŒæ–°æ©Ÿèƒ½ï¼šãƒ‡ãƒ¼ã‚¿ã«ã‚ã‚‹ã‚­ãƒ¼ï¼ˆlevel_1ãªã©ï¼‰ã®åˆ†ã ã‘ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹
            const container = document.getElementById('mode-container');
            container.innerHTML = ''; // "Loading..." ã‚’æ¶ˆã™
            
            // ã‚­ãƒ¼ã‚’ã€Œlevel_1, level_2...ã€ã®é †ã«ä¸¦ã¹æ›¿ãˆãŸã„å ´åˆã®å‡¦ç†
            const sortedKeys = Object.keys(database).sort((a, b) => {
                // æ•°å­—éƒ¨åˆ†ã‚’å–ã‚Šå‡ºã—ã¦æ¯”è¼ƒï¼ˆlevel_1 vs level_10 å¯¾ç­–ï¼‰
                const numA = parseInt(a.replace(/\D/g, '')) || 0;
                const numB = parseInt(b.replace(/\D/g, '')) || 0;
                return numA - numB;
            });

            sortedKeys.forEach((key, index) => {
                const btn = document.createElement('button');
                btn.className = 'mode-btn';
                // è¡¨ç¤ºåã‚’ä½œã‚‹ï¼ˆkeyãã®ã¾ã¾ã€ã‚ã‚‹ã„ã¯æ•´å½¢ï¼‰
                // ä¾‹: "level_1" â†’ "Lv.1"
                const label = key.replace('level_', 'Lv.').toUpperCase();
                btn.innerText = label;
                btn.onclick = () => setMode(key);
                container.appendChild(btn);
            });

            document.getElementById('accent-display').innerText = "Select Level";
            
            // æœ€åˆã¯ä¸€ç•ªã‚„ã•ã—ã„ãƒ¬ãƒ™ãƒ«(æœ€åˆã®ã‚­ãƒ¼)ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            if (sortedKeys.length > 0) {
                // è‡ªå‹•å†ç”Ÿã¯ã‚ªãƒ•(false)ã§ã‚»ãƒƒãƒˆ
                setMode(sortedKeys[0]);
            }

        } catch (error) {
            console.error("Error:", error);
            document.getElementById('mode-container').innerText = "Error loading data.";
        }
    }

    // setModeé–¢æ•°ã‚‚ã€å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«å¯¾å¿œã•ã›ã‚‹
    function setMode(modeName) {
        if (!database[modeName]) return;
        currentMode = modeName;
        currentList = [...database[modeName]];
        sessionHistory = [];
        
        // å…¨ãƒœã‚¿ãƒ³ã®activeã‚’å¤–ã™
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        
        // ä»Šå›æŠ¼ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’æ¢ã—ã¦activeã«ã™ã‚‹
        // (å‹•çš„ç”Ÿæˆã•ã‚ŒãŸãƒœã‚¿ãƒ³ã¯onclickå±æ€§ã§æ¢ã™ã®ãŒé›£ã—ã„ã®ã§ã€ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ãªã©ã§æ¢ã™ã‹ã€
        //  ã‚‚ã£ã¨ç°¡å˜ã«ã€ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®é€ä¿¡å…ƒ(event.target)ã‚’ä½¿ã„ã¾ã™)
        if (event && event.target && event.target.classList.contains('mode-btn')) {
            event.target.classList.add('active');
        } else {
            // è‡ªå‹•é¸æŠæ™‚ãªã©ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã§æ¢ã™
            const label = modeName.replace('level_', 'Lv.').toUpperCase();
            const btns = document.querySelectorAll('.mode-btn');
            for (let btn of btns) {
                if (btn.innerText === label) {
                    btn.classList.add('active');
                    break;
                }
            }
        }
        
        document.getElementById('game-container').style.display = 'block';
        document.getElementById('history-section').style.display = 'none';
        document.getElementById('history-list').innerHTML = '';

        nextProblem(false);
    }
        
        function loadProblem(autoPlay = true) {
            if (sessionHistory.length >= PROBLEMS_PER_SESSION || currentList.length === 0) {
                finishSession();
                return;
            }
    
            const randomIndex = Math.floor(Math.random() * currentList.length);
            // ãƒªã‚¹ãƒˆã‹ã‚‰æŠœãå‡ºã™ï¼ˆspliceï¼‰å‰ã«ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãŠã
            const rawData = currentList.splice(randomIndex, 1)[0];
            
            // â˜…ã“ã“ãŒæ–°æ©Ÿèƒ½ï¼šãƒ©ãƒ³ãƒ€ãƒ ã«ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚’æ±ºå®šã—ã¦ã€å•é¡Œãƒ‡ãƒ¼ã‚¿ã«ãã£ã¤ã‘ã‚‹
            const randomAccent = ACCENTS[Math.floor(Math.random() * ACCENTS.length)];
            
            currentProblem = {
                ...rawData,                 // å˜èªãƒ‡ãƒ¼ã‚¿
                selectedAccent: randomAccent // ä»Šå›é¸ã°ã‚ŒãŸã‚¢ã‚¯ã‚»ãƒ³ãƒˆ
            };
            
            // ç”»é¢è¡¨ç¤º
            document.getElementById('accent-display').innerText = currentProblem.selectedAccent.name;
            document.getElementById('user-input').value = '';
            document.getElementById('feedback').innerText = '';
            document.getElementById('user-input').focus();
            
            if (autoPlay) {
                setTimeout(speakWord, 300);
            } else {
                document.getElementById('feedback').innerText = "Press ğŸ”Š to start";
            }
        }
    
        function speakWord() {
            if (!currentProblem) return;
            
            // â˜…ãƒ•ã‚¡ã‚¤ãƒ«åã®æŒ‡å®šæ–¹æ³•ãŒå¤‰ã‚ã‚Šã¾ã™: å˜èª_å›½ã‚³ãƒ¼ãƒ‰.mp3
            const audioPath = `audio/${currentProblem.word}_${currentProblem.selectedAccent.code}.mp3`;
            
            const audio = new Audio(audioPath);
            audio.play().catch(() => {
                console.log("File missing, fallback to robot.");
                const u = new SpeechSynthesisUtterance(currentProblem.word);
                u.lang = "en-US";
                window.speechSynthesis.speak(u);
            });
            document.getElementById('user-input').focus();
        }
    
        function checkAnswer() {
            const userSpelling = document.getElementById('user-input').value.trim().toLowerCase();
            const correctSpelling = currentProblem.word.toLowerCase();
            const feedbackDiv = document.getElementById('feedback');
    
            if (userSpelling === "") return;
    
            const isCorrect = (userSpelling === correctSpelling);
            
            if (isCorrect) {
                feedbackDiv.innerHTML = "âœ“";
            } else {
                feedbackDiv.innerHTML = `<span class='correct-answer'>${correctSpelling}</span>`;
            }
    
            sessionHistory.push({
                wordData: currentProblem,
                userAnswer: userSpelling,
                isCorrect: isCorrect
            });
    
            setTimeout(() => nextProblem(true), 2000);
        }
    
        function nextProblem(autoPlay = true) {
            loadProblem(autoPlay);
        }
    
        function finishSession() {
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('history-section').style.display = 'block';
            
            const historyList = document.getElementById('history-list');
            sessionHistory.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'history-item';
                
                const statusClass = item.isCorrect ? 'status-correct' : 'status-wrong';
                const statusText = item.isCorrect ? 'âœ“ Correct' : `âœ— Wrong (typed: ${item.userAnswer})`;
                const synonyms = item.wordData.synonyms ? item.wordData.synonyms.join(", ") : "-";
                const antonyms = item.wordData.antonyms ? item.wordData.antonyms.join(", ") : "-";
    
                // å±¥æ­´ã«ã‚‚ã€Œã©ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã§å‡ºé¡Œã•ã‚ŒãŸã‹ã€ã‚’è¡¨ç¤º
                li.innerHTML = `
                    <div class="history-word">${item.wordData.word}</div>
                    <div class="history-status ${statusClass}">${statusText} - ${item.wordData.selectedAccent.name}</div>
                    <div class="word-details" id="details-${index}">
                        <div class="detail-row"><span class="detail-label">Synonyms:</span> ${synonyms}</div>
                        <div class="detail-row"><span class="detail-label">Antonyms:</span> ${antonyms}</div>
                    </div>
                `;
                li.onclick = () => {
                    const details = document.getElementById(`details-${index}`);
                    details.style.display = details.style.display === 'block' ? 'none' : 'block';
                };
                historyList.appendChild(li);
            });
        }
    
        window.onload = loadDatabase;
    
    </script>
</body>
</html>