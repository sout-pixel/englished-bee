<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Englishes Bee - Mode Selection</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --text: #333;
            --bg: #fcfcfc;
            --accent: #555; /* è½ã¡ç€ã„ãŸã‚°ãƒ¬ãƒ¼ */
            --border: #ddd;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box;
        }
        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å»ƒæ­¢ã—ã€ãƒŸãƒ‹ãƒãƒ«ãªã‚³ãƒ³ãƒ†ãƒŠã«å¤‰æ›´ */
        .container {
            max-width: 600px; width: 100%; text-align: center;
        }
        h1 { margin: 0 0 30px 0; font-size: 1.5rem; letter-spacing: 1px; font-weight: normal; }
        
        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚’ã‚·ãƒ³ãƒ—ãƒ«ã« */
        .mode-selector { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
        .mode-btn {
            background: none; border: none; padding: 8px 0;
            font-size: 0.9rem; cursor: pointer; color: #999;
            border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .mode-btn.active { color: var(--text); border-bottom-color: var(--accent); }

        /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè¡¨ç¤º */
        .accent-display { font-size: 0.9rem; color: #777; margin-bottom: 20px; }

        /* å†ç”Ÿãƒœã‚¿ãƒ³ */
        button#play-btn {
            background: none; border: 2px solid var(--border); width: 70px; height: 70px; border-radius: 50%;
            font-size: 1.8rem; cursor: pointer; margin: 0 auto 30px auto; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; color: var(--accent);
        }
        button#play-btn:hover { border-color: var(--accent); }
        button#play-btn:active { transform: scale(0.95); }

        /* å…¥åŠ›æ¬„ */
        input[type="text"] {
            width: 100%; max-width: 300px; padding: 10px; font-size: 1.2rem;
            border: none; border-bottom: 2px solid var(--border);
            text-align: center; outline: none; text-transform: lowercase; margin-bottom: 20px;
            background: transparent; transition: border-color 0.2s;
        }
        input[type="text"]:focus { border-bottom-color: var(--accent); }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆæ­£èª¤è¡¨ç¤ºï¼‰ */
        .feedback { min-height: 24px; margin-bottom: 30px; font-size: 1rem; }
        .correct-answer { color: #d32f2f; font-weight: bold; } /* é–“é•ãˆãŸæ™‚ã®ç­”ãˆè¡¨ç¤º */

        /* å±¥æ­´ã‚¨ãƒªã‚¢ï¼ˆæœ€åˆã¯éš ã™ï¼‰ */
        #history-section {
            display: none; /* ã‚²ãƒ¼ãƒ ä¸­ã¯éè¡¨ç¤º */
            margin-top: 50px; width: 100%; text-align: left; border-top: 1px solid var(--border); padding-top: 30px;
        }
        .history-title { font-size: 1.1rem; margin-bottom: 20px; text-align: center; }
        .history-list { list-style: none; padding: 0; }
        .history-item {
            padding: 15px; border-bottom: 1px solid var(--border);
            cursor: pointer; transition: background 0.2s;
        }
        .history-item:hover { background: #f9f9f9; }
        .history-word { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        .history-status { font-size: 0.8rem; }
        .status-correct { color: #2e7d32; } .status-wrong { color: #d32f2f; }
        
        /* è©³ç´°æƒ…å ±ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãéƒ¨åˆ†ï¼‰ */
        .word-details { display: none; margin-top: 10px; font-size: 0.9rem; color: #555; padding-left: 10px; border-left: 3px solid var(--border); }
        .detail-row { margin-bottom: 5px; }
        .detail-label { font-weight: bold; margin-right: 5px; }
    </style>
</head>
<body></body>
    <div class="container" id="game-container">
        <h1>Englishes Bee</h1>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('world')">World</button>
            <button class="mode-btn" onclick="setMode('eiken2')">è‹±æ¤œ2ç´š</button>
        </div>

        <div id="accent-display" class="accent-display">Loading...</div>
        
        <button id="play-btn" onclick="speakWord()">ğŸ”Š</button>
        <input type="text" id="user-input" placeholder="type here" onkeydown="if(event.key === 'Enter') checkAnswer()" autocomplete="off">
        <div id="feedback" class="feedback"></div>
        
        </div>

    <div class="container" id="history-section">
        <h2 class="history-title">Today's Session History</h2>
        <ul class="history-list" id="history-list">
            </ul>
        <button onclick="location.reload()" style="margin-top:30px; background:none; border:1px solid #ddd; padding:10px 20px; cursor:pointer;">Restart Session</button>
    </div>
    <script>
        let database = {};
        let currentMode = "world";
        let currentList = [];
        let currentProblem = null; // ç¾åœ¨ã®å•é¡Œãƒ‡ãƒ¼ã‚¿
        let sessionHistory = [];   // ä»Šå›ã®å­¦ç¿’å±¥æ­´ã‚’è²¯ã‚ã‚‹å ´æ‰€
        const PROBLEMS_PER_SESSION = 5; // 1å›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å•é¡Œæ•°ï¼ˆãƒ†ã‚¹ãƒˆç”¨ã«5å•ã«è¨­å®šï¼‰
    
        async function loadDatabase() {
            try {
                const response = await fetch('words.json');
                database = await response.json();
                document.getElementById('accent-display').innerText = "Select Mode";
                setMode('world');
            } catch (error) {
                console.error("Error:", error);
            }
        }
    
        function setMode(modeName) {
        if (!database[modeName]) return;
        currentMode = modeName;
        currentList = [...database[modeName]]; 
        sessionHistory = [];
        
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        const btn = document.querySelector(`button[onclick="setMode('${modeName}')"]`);
        if(btn) btn.classList.add('active');
        
        document.getElementById('game-container').style.display = 'block';
        document.getElementById('history-section').style.display = 'none';
        document.getElementById('history-list').innerHTML = '';

        // ã€å¤‰æ›´ç‚¹ã€‘æœ€åˆã¯è‡ªå‹•å†ç”Ÿã—ãªã„ (falseã‚’æ¸¡ã™)
        nextProblem(false);
    }
    
  // ã€å¤‰æ›´ç‚¹ã€‘autoPlayå¼•æ•°ã‚’å—ã‘å–ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯trueï¼‰
  function loadProblem(autoPlay = true) {
        if (sessionHistory.length >= PROBLEMS_PER_SESSION || currentList.length === 0) {
            finishSession();
            return;
        }

        const randomIndex = Math.floor(Math.random() * currentList.length);
        currentProblem = currentList.splice(randomIndex, 1)[0];
        
        document.getElementById('accent-display').innerText = currentProblem.accentName;
        document.getElementById('user-input').value = '';
        document.getElementById('feedback').innerText = '';
        document.getElementById('user-input').focus();
        
        // ã€å¤‰æ›´ç‚¹ã€‘autoPlayãŒtrueã®æ™‚ã ã‘å†ç”Ÿã™ã‚‹
        if (autoPlay) {
            setTimeout(speakWord, 300);
        } else {
            // å†ç”Ÿã—ãªã„å ´åˆã¯ã€ã€ŒæŠ¼ã—ã¦èã„ã¦ã­ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™ã¨è¦ªåˆ‡
            document.getElementById('feedback').innerText = "Press ğŸ”Š to start";
        }
    }  
        function speakWord() {
            if (!currentProblem) return;
            const audioPath = `audio/${currentProblem.word}.mp3`;
            const audio = new Audio(audioPath);
            audio.play().catch(() => {
                const u = new SpeechSynthesisUtterance(currentProblem.word);
                u.lang = "en-US";
                window.speechSynthesis.speak(u);
            });
            document.getElementById('user-input').focus();
        }
    
        function checkAnswer() {
            const userSpelling = document.getElementById('user-input').value.trim().toLowerCase();
            const correctSpelling = currentProblem.word.toLowerCase();
            const feedbackDiv = document.getElementById('feedback');
    
            if (userSpelling === "") return;
    
            const isCorrect = (userSpelling === correctSpelling);
            
            // 1. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
            if (isCorrect) {
                feedbackDiv.innerHTML = "âœ“"; // æ­£è§£ãªã‚‰ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã ã‘
            } else {
                // é–“é•ã„ãªã‚‰ã€èµ¤å­—ã§ç­”ãˆã ã‘ã‚’å‡ºã™
                feedbackDiv.innerHTML = `<span class='correct-answer'>${correctSpelling}</span>`;
            }
    
            // 2. å±¥æ­´ã«ä¿å­˜
            sessionHistory.push({
                wordData: currentProblem,
                userAnswer: userSpelling,
                isCorrect: isCorrect
            });
    
            // 3. æ·¡ã€…ã¨æ¬¡ã¸ï¼ˆ2ç§’å¾Œï¼‰
            setTimeout(nextProblem, 2000);
        }
    
// ã€å¤‰æ›´ç‚¹ã€‘å¼•æ•°ã‚’ãã®ã¾ã¾ loadProblem ã«æ¸¡ã™
function nextProblem(autoPlay = true) {
        loadProblem(autoPlay);
    }    
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã®å‡¦ç†ï¼ˆå±¥æ­´ç”»é¢ã®è¡¨ç¤ºï¼‰
        function finishSession() {
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('history-section').style.display = 'block';
            
            const historyList = document.getElementById('history-list');
            sessionHistory.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'history-item';
                
                const statusClass = item.isCorrect ? 'status-correct' : 'status-wrong';
                const statusText = item.isCorrect ? 'âœ“ Correct' : `âœ— Wrong (typed: ${item.userAnswer})`;
    
                // â€»åŒç¾©èªãƒ»åç¾©èªãƒ‡ãƒ¼ã‚¿ã¯ã¾ã JSONã«ãªã„ã®ã§ä»®ã®ã‚‚ã®ã‚’è¡¨ç¤º
                const synonyms = item.wordData.synonyms ? item.wordData.synonyms.join(", ") : "(ãƒ‡ãƒ¼ã‚¿ãªã—)";
                const antonyms = item.wordData.antonyms ? item.wordData.antonyms.join(", ") : "(ãƒ‡ãƒ¼ã‚¿ãªã—)";
    
                li.innerHTML = `
                    <div class="history-word">${item.wordData.word}</div>
                    <div class="history-status ${statusClass}">${statusText} - ${item.wordData.accentName}</div>
                    <div class="word-details" id="details-${index}">
                        <div class="detail-row"><span class="detail-label">Synonyms(åŒç¾©èª):</span> ${synonyms}</div>
                        <div class="detail-row"><span class="detail-label">Antonyms(åç¾©èª):</span> ${antonyms}</div>
                    </div>
                `;
                
                // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’é–‹é–‰ã™ã‚‹æ©Ÿèƒ½
                li.onclick = () => {
                    const details = document.getElementById(`details-${index}`);
                    details.style.display = details.style.display === 'block' ? 'none' : 'block';
                };
                
                historyList.appendChild(li);
            });
        }
    
        window.onload = loadDatabase;
    
    </script>
</body>
</html>