<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Englishes Bee</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --text: #333;
            --bg: #fcfcfc;
            --accent: #555; /* ËêΩ„Å°ÁùÄ„ÅÑ„Åü„Ç∞„É¨„Éº */
            --border: #ddd;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box;
        }
        .container {
            max-width: 600px; width: 100%; text-align: center;
        }
        h1 { margin: 0 0 30px 0; font-size: 1.5rem; letter-spacing: 1px; font-weight: normal; }
        
        /* „É¢„Éº„ÉâÈÅ∏Êäû„Ç®„É™„Ç¢ */
        .mode-selector { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .mode-btn {
            background: none; border: none; padding: 8px 0;
            font-size: 0.9rem; cursor: pointer; color: #999;
            border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .mode-btn.active { color: var(--text); border-bottom-color: var(--accent); }

        /* „Ç¢„ÇØ„Çª„É≥„ÉàË°®Á§∫ */
        .accent-display { font-size: 0.9rem; color: #777; margin-bottom: 20px; }

        /* ÂÜçÁîü„Éú„Çø„É≥ */
        button#play-btn {
            background: none; border: 2px solid var(--border); width: 70px; height: 70px; border-radius: 50%;
            font-size: 1.8rem; cursor: pointer; margin: 0 auto 30px auto; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; color: var(--accent);
        }
        button#play-btn:hover { border-color: var(--accent); }
        button#play-btn:active { transform: scale(0.95); }

        /* ÂÖ•ÂäõÊ¨Ñ */
        input[type="text"] {
            width: 100%; max-width: 300px; padding: 10px; font-size: 1.2rem;
            border: none; border-bottom: 2px solid var(--border);
            text-align: center; outline: none; text-transform: lowercase; margin-bottom: 20px;
            background: transparent; transition: border-color 0.2s;
        }
        input[type="text"]:focus { border-bottom-color: var(--accent); }

        /* „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ */
        .feedback { min-height: 24px; margin-bottom: 30px; font-size: 1rem; }
        .correct-answer { color: #d32f2f; font-weight: bold; }

        /* Â±•Ê≠¥„Ç®„É™„Ç¢ */
        #history-section {
            display: none; margin-top: 50px; width: 100%; text-align: left; border-top: 1px solid var(--border); padding-top: 30px;
        }
        .history-title { font-size: 1.1rem; margin-bottom: 20px; text-align: center; }
        .history-list { list-style: none; padding: 0; }
        .history-item {
            padding: 15px; border-bottom: 1px solid var(--border);
            cursor: pointer; transition: background 0.2s;
        }
        .history-item:hover { background: #f9f9f9; }
        .history-word { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        .history-status { font-size: 0.8rem; }
        .status-correct { color: #2e7d32; } .status-wrong { color: #d32f2f; }
        
        .word-details { display: none; margin-top: 10px; font-size: 0.9rem; color: #555; padding-left: 10px; border-left: 3px solid var(--border); }
        .detail-row { margin-bottom: 5px; }
        .detail-label { font-weight: bold; margin-right: 5px; }

        /* „Ç∑„Çß„Ç¢„Éú„Çø„É≥Á≠â */
        .action-buttons {
            display: flex; gap: 10px; justify-content: center; margin-top: 30px;
        }
        .action-btn {
            border: none; padding: 12px 24px; border-radius: 50px;
            font-size: 1rem; cursor: pointer; font-weight: bold; transition: transform 0.1s;
        }
        .action-btn:active { transform: translateY(2px); }
        .share-btn { background-color: var(--text); color: var(--bg); }
        .restart-btn { background-color: transparent; border: 2px solid var(--border); color: #777; }
    </style>
</head>
<body>
    <div class="container" id="game-container">
        <h1>Englishes Bee</h1>
        
        <div class="mode-selector" style="margin-bottom: 10px;">
            <button class="mode-btn" onclick="setMode('endless')" style="color: #d32f2f; font-weight:bold;">üî• Endless</button>
        </div>
        
        <div class="mode-selector" id="mode-container">
            Loading levels...
        </div>

        <div id="accent-display" class="accent-display">Select Level</div>
        
        <button id="play-btn" onclick="speakWord()">üîä</button>
        <input type="text" id="user-input" placeholder="type here" onkeydown="if(event.key === 'Enter') checkAnswer()" autocomplete="off">
        <div id="feedback" class="feedback"></div>
    </div>

    <div class="container" id="history-section">
        <h2 class="history-title">Session Result</h2>
        <ul class="history-list" id="history-list"></ul>
        
        <div class="action-buttons">
            <button class="action-btn share-btn" id="share-btn" onclick="shareResults()">Share Results üìã</button>
            <button class="action-btn restart-btn" onclick="location.reload()">Try Again ‚Üª</button>
        </div>
    </div>

<script>
    let database = {};
    let currentMode = "world";
    let currentList = [];
    let currentProblem = null;
    let sessionHistory = [];
    const PROBLEMS_PER_SESSION = 5;

    // 10Á®ÆÈ°û„ÅÆ„Ç¢„ÇØ„Çª„É≥„ÉàÂÆöÁæ©
    const ACCENTS = [
        { code: "us", name: "American üá∫üá∏" },
        { code: "uk", name: "British üá¨üáß" },
        { code: "au", name: "Australian üá¶üá∫" },
        { code: "in", name: "Indian üáÆüá≥" },
        { code: "ie", name: "Irish (Celtic) üáÆüá™" },
        { code: "za", name: "South African üáøüá¶" },
        { code: "ng", name: "Nigerian üá≥üá¨" },
        { code: "es", name: "Spanish Style üá™üá∏" },
        { code: "cn", name: "Chinese Style üá®üá≥" },
        { code: "jp", name: "Japanese Style üáØüáµ" }
    ];

    async function loadDatabase() {
        try {
            const response = await fetch('words.json');
            database = await response.json();
            
            const container = document.getElementById('mode-container');
            container.innerHTML = '';
            
            const sortedKeys = Object.keys(database).sort((a, b) => {
                const numA = parseInt(a.replace(/\D/g, '')) || 0;
                const numB = parseInt(b.replace(/\D/g, '')) || 0;
                return numA - numB;
            });

            sortedKeys.forEach((key) => {
                const btn = document.createElement('button');
                btn.className = 'mode-btn';
                const label = key.replace('level_', 'Lv.').toUpperCase();
                btn.innerText = label;
                btn.onclick = () => setMode(key);
                container.appendChild(btn);
            });

            document.getElementById('accent-display').innerText = "Select Level";
            
            // ÂàùÊúüÁä∂ÊÖã„ÅØLv.1„ÇíÈÅ∏ÊäûÔºàËá™ÂãïÂÜçÁîü„Å™„ÅóÔºâ
            if (sortedKeys.length > 0) {
                setMode(sortedKeys[0]);
            }

        } catch (error) {
            console.error("Error:", error);
            document.getElementById('mode-container').innerText = "Error loading data.";
        }
    }

    function setMode(modeName) {
        if (modeName === 'endless') {
            currentMode = 'endless';
            currentList = Object.values(database).flat();
            currentList.sort(() => Math.random() - 0.5);
        } else {
            if (!database[modeName]) return;
            currentMode = modeName;
            currentList = [...database[modeName]];
        }

        sessionHistory = [];
        
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        
        if (modeName === 'endless') {
            const endlessBtn = document.querySelector('button[onclick="setMode(\'endless\')"]');
            if(endlessBtn) endlessBtn.classList.add('active');
        } else {
            if (event && event.target && event.target.classList.contains('mode-btn')) {
                event.target.classList.add('active');
            }
        }
        
        document.getElementById('game-container').style.display = 'block';
        document.getElementById('history-section').style.display = 'none';
        document.getElementById('history-list').innerHTML = '';

        nextProblem(false);
    }

    function loadProblem(autoPlay = true) {
        // Endless„É¢„Éº„Éâ‰ª•Â§ñ„ÅÆ„ÅøÂïèÈ°åÊï∞Âà∂Èôê„ÇíÈÅ©Áî®
        const isLimitReached = (currentMode !== 'endless' && sessionHistory.length >= PROBLEMS_PER_SESSION);
        
        if (isLimitReached || currentList.length === 0) {
            finishSession();
            return;
        }

        const randomIndex = Math.floor(Math.random() * currentList.length);
        const rawData = currentList.splice(randomIndex, 1)[0];
        
        const randomAccent = ACCENTS[Math.floor(Math.random() * ACCENTS.length)];
        
        currentProblem = {
            ...rawData,
            selectedAccent: randomAccent
        };
        
        document.getElementById('accent-display').innerText = currentProblem.selectedAccent.name;
        document.getElementById('user-input').value = '';
        document.getElementById('feedback').innerText = '';
        document.getElementById('user-input').focus();
        
        if (autoPlay) {
            setTimeout(speakWord, 300);
        } else {
            document.getElementById('feedback').innerText = "Press üîä to start";
        }
    }

    function speakWord() {
        if (!currentProblem) return;
        const audioPath = `audio/${currentProblem.word}_${currentProblem.selectedAccent.code}.mp3`;
        
        const audio = new Audio(audioPath);
        audio.play().catch(() => {
            console.log("File missing, fallback to robot.");
            const u = new SpeechSynthesisUtterance(currentProblem.word);
            u.lang = "en-US";
            window.speechSynthesis.speak(u);
        });
        document.getElementById('user-input').focus();
    }

    function checkAnswer() {
        const userSpelling = document.getElementById('user-input').value.trim().toLowerCase();
        const correctSpelling = currentProblem.word.toLowerCase();
        const feedbackDiv = document.getElementById('feedback');

        if (userSpelling === "") return;

        const isCorrect = (userSpelling === correctSpelling);
        
        // Â±•Ê≠¥„Å´ËøΩÂä†
        sessionHistory.push({
            wordData: currentProblem,
            userAnswer: userSpelling,
            isCorrect: isCorrect
        });

        if (isCorrect) {
            // Ê≠£Ëß£„ÅÆÂ†¥ÂêàÔºö„Ç∑„É≥„Éó„É´„Å´‚úì„ÇíÂá∫„Åó„Å¶Ê¨°„Å∏
            feedbackDiv.innerHTML = "‚úì";
            setTimeout(() => nextProblem(true), 1500); // „ÉÜ„É≥„Éù„Çà„ÅèÊ¨°„Å∏
        } else {
            // ‰∏çÊ≠£Ëß£„ÅÆÂ†¥Âêà
            feedbackDiv.innerHTML = `<span class='correct-answer'>${correctSpelling}</span>`;
            
            // ‚òÖ„Åì„Åì„ÅåÂ§âÊõ¥ÁÇπÔºö„É¢„Éº„Éâ„Å´„Çà„Å£„Å¶ÊåôÂãï„ÇíÂ§â„Åà„Çã
            if (currentMode === 'endless') {
                // Endless„É¢„Éº„Éâ„Å™„Çâ„ÄÅÈñìÈÅï„Åà„ÅüÊôÇÁÇπ„Åß„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÔºÅ
                // Á≠î„Åà„ÇíÁ¢∫Ë™ç„Åô„ÇãÊôÇÈñì„Çí3Áßí‰∏é„Åà„Å¶„Åã„Çâ„ÄÅÁµêÊûúÁîªÈù¢„Å∏
                setTimeout(finishSession, 3000);
            } else {
                // ÈÄöÂ∏∏„É¢„Éº„Éâ„Å™„Çâ„ÄÅÈñìÈÅï„Åà„Å¶„ÇÇÊúÄÂæå„Åæ„ÅßÔºà5ÂïèÔºâÁ∂ö„Åë„Çã
                setTimeout(() => nextProblem(true), 2500);
            }
        }
    }

    function nextProblem(autoPlay = true) {
        loadProblem(autoPlay);
    }

    function finishSession() {
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('history-section').style.display = 'block';
        
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = ''; // „É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢
        
        // ‚òÖÂ§âÊõ¥ÁÇπÔºöÊ≠£Ëß£Êï∞ÔºàStreakÔºâ„ÇíË®àÁÆó„Åó„Å¶„Çø„Ç§„Éà„É´„Å´Ë°®Á§∫
        const correctCount = sessionHistory.filter(h => h.isCorrect).length;
        const titleElement = document.querySelector('.history-title');
        
        if (currentMode === 'endless') {
            titleElement.innerText = `Game Over! Streak: ${correctCount} üî•`;
        } else {
            titleElement.innerText = `Session Result (${correctCount}/${sessionHistory.length})`;
        }

        sessionHistory.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'history-item';
            
            const statusClass = item.isCorrect ? 'status-correct' : 'status-wrong';
            const statusText = item.isCorrect ? '‚úì Correct' : `‚úó Wrong (typed: ${item.userAnswer})`;
            const synonyms = item.wordData.synonyms ? item.wordData.synonyms.join(", ") : "-";
            const antonyms = item.wordData.antonyms ? item.wordData.antonyms.join(", ") : "-";

            li.innerHTML = `
                <div class="history-word">${item.wordData.word}</div>
                <div class="history-status ${statusClass}">${statusText} - ${item.wordData.selectedAccent.name}</div>
                <div class="word-details" id="details-${index}">
                    <div class="detail-row"><span class="detail-label">Synonyms:</span> ${synonyms}</div>
                    <div class="detail-row"><span class="detail-label">Antonyms:</span> ${antonyms}</div>
                </div>
            `;
            li.onclick = () => {
                const details = document.getElementById(`details-${index}`);
                details.style.display = details.style.display === 'block' ? 'none' : 'block';
            };
            historyList.appendChild(li);
        });
    }

    function shareResults() {
        const flags = { 
            "us": "üá∫üá∏", "uk": "üá¨üáß", "au": "üá¶üá∫", "in": "üáÆüá≥",
            "ie": "üáÆüá™", "za": "üáøüá¶", "ng": "üá≥üá¨",
            "es": "üá™üá∏", "cn": "üá®üá≥", "jp": "üáØüáµ"
        };
        
        const correctCount = sessionHistory.filter(h => h.isCorrect).length;
        const total = sessionHistory.length;
        
        let text = "";
        
        // ‚òÖÂ§âÊõ¥ÁÇπÔºö„É¢„Éº„Éâ„Å´„Çà„Å£„Å¶„Ç∑„Çß„Ç¢ÊñáË®Ä„ÇíÂ§â„Åà„Çã
        if (currentMode === 'endless') {
            text = `Englishes Bee üêù\nMode: Endless Survival üî•\nStreak: ${correctCount}\n\n`;
        } else {
            let modeLabel = currentMode.replace('level_', 'Lv.');
            text = `Englishes Bee üêù\nMode: ${modeLabel}\nScore: ${correctCount}/${total}\n\n`;
        }

        sessionHistory.forEach((h, i) => {
            const flag = flags[h.wordData.selectedAccent.code] || "üè≥Ô∏è";
            const mark = h.isCorrect ? "‚úÖ" : "üíÄ"; // Endless„ÅßË≤†„Åë„ÅüÊôÇ„ÅØ„Éâ„ÇØ„É≠„Éû„Éº„ÇØ„Å´„Åô„ÇãÊºîÂá∫
            const wordInfo = h.isCorrect ? "" : ` (${h.wordData.word})`;
            
            text += `${i + 1}. ${flag} ${mark}${wordInfo}\n`;
        });

        text += `\n${window.location.href}`;

        navigator.clipboard.writeText(text).then(() => {
            const btn = document.getElementById('share-btn');
            const originalText = btn.innerText;
            btn.innerText = "Copied! ‚ú®";
            btn.style.backgroundColor = "#4CAF50";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.backgroundColor = "";
            }, 2000);
        }).catch(err => {
            console.error('Copy failed', err);
            alert("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
        });
    }
    
    window.onload = loadDatabase;

</script>
</body>
</html>